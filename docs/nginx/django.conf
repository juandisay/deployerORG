## Upstream: Django application backends (Gunicorn/ASGI)
upstream django_backend {
        server 127.0.0.1:8000 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:9000 backup;
        keepalive 64;
}

## Rate limiting zones (http-level)
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

## Basic bot protection
map $http_user_agent $bad_bot {
        default 0;
        ~*(curl|wget|python-requests|scrapy) 1;
}

## HTTP â†’ HTTPS redirection for all subdomains
server {
        listen 80;
        server_name example.com .example.com api.example.com;
        return 301 https://$host$request_uri;
}

## Main domain and all subdomains over HTTPS
server {
        listen 443 ssl http2;
        server_name example.com .example.com;

        ## SSL configuration
        ssl_certificate /etc/ssl/certs/example.com.crt;
        ssl_certificate_key /etc/ssl/private/example.com.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        ssl_stapling on;
        ssl_stapling_verify on;
        ssl_trusted_certificate /etc/ssl/certs/example.com.chain.crt;

        ## Logging
        access_log /var/log/nginx/django_access.log;
        error_log  /var/log/nginx/django_error.log warn;

        ## Security headers
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header Referrer-Policy no-referrer-when-downgrade;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
        add_header X-XSS-Protection "1; mode=block";
        add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self';";

        ## Client and proxy buffers
        client_max_body_size 100M;
        client_body_buffer_size 200K;
        client_header_buffer_size 2k;
        large_client_header_buffers 3 1k;
        client_body_timeout 5s;
        client_header_timeout 5s;

        ## Compression
        gzip on;
        gzip_comp_level 5;
        gzip_min_length 256;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        ## Static files
        location /static {
                alias /var/www/django/static;
                expires 7d;
                add_header Cache-Control "public, max-age=604800";
        }

        ## Media files
        location /media {
                alias /var/www/django/media;
                expires 1d;
                add_header Cache-Control "public, max-age=86400";
        }

        ## Block access to hidden files
        location ~ /\. {
                deny all;
        }

        ## Health check endpoint (proxied to app)
        location = /healthz {
                include proxy_params;
                proxy_pass http://django_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_connect_timeout 2s;
                proxy_read_timeout 2s;
        }

        ## Restricted admin
        location ^~ /admin {
                auth_basic "Admin Area";
                auth_basic_user_file /etc/nginx/.htpasswd_admin;
                allow 127.0.0.1;
                allow 192.168.0.0/16;
                deny all;
                include proxy_params;
                proxy_pass http://django_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-Proto $scheme;
                limit_req zone=req_limit_per_ip burst=20 nodelay;
                limit_conn conn_limit_per_ip 20;
        }

        ## API endpoint restrictions
        location ^~ /api {
                auth_basic "API Restricted";
                auth_basic_user_file /etc/nginx/.htpasswd_api;
                include proxy_params;
                proxy_pass http://django_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-Proto $scheme;
                limit_req zone=req_limit_per_ip burst=50 nodelay;
                limit_conn conn_limit_per_ip 50;
        }

        ## Main application
        location / {
                if ($bad_bot) { return 403; }
                include proxy_params;
                proxy_pass http://django_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering on;
                proxy_buffers 16 16k;
                proxy_busy_buffers_size 24k;
        }

        ## Error pages
        error_page 403 /403.html;
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
        location = /403.html { root /var/www/django/static; }
        location = /404.html { root /var/www/django/static; }
        location = /50x.html { root /var/www/django/static; }
}

## Dedicated API subdomain (optional override)
server {
        listen 443 ssl http2;
        server_name api.example.com;

        ssl_certificate /etc/ssl/certs/example.com.crt;
        ssl_certificate_key /etc/ssl/private/example.com.key;

        access_log /var/log/nginx/api_access.log;
        error_log  /var/log/nginx/api_error.log warn;

        location / {
                include proxy_params;
                proxy_pass http://django_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                limit_req zone=req_limit_per_ip burst=100 nodelay;
                limit_conn conn_limit_per_ip 100;
        }
}
